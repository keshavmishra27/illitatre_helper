<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ™ï¸ Voice Agent â€“ Multilingual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>s
    body {
      background-color: #0d1117;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar { background-color: #161b22; }
    .card {
      background-color: #1c2128;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .btn-success { background-color: #238636; border: none; }
    .btn-danger { background-color: #da3633; border: none; }

    .conversation-bubble {
      border-radius: 20px;
      padding: 10px 15px;
      margin: 6px 0;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user-msg {
      background-color: #238636;
      align-self: flex-end;
    }
    .ai-msg {
      background-color: #30363d;
      align-self: flex-start;
    }
  </style>
</head>

<body>
<nav class="navbar navbar-dark px-3">
  <span class="navbar-brand">ğŸ™ï¸ Voice Agent (Multilingual)</span>
  <a href="/ocr" class="btn btn-outline-light btn-sm">ğŸ§¾ OCR Extractor</a>
</nav>

<div class="container mt-4">
  <div class="card p-4">

    <h4 class="text-info text-center mb-3">User Profile Status</h4>
    <ul>
      <li><b>Name:</b> {{ user.name }}</li>
      <li><b>Age:</b> {{ user.age if user.age != 0 else "N/A" }}</li>
      <li><b>Preferred Language:</b> {{ user.language }}</li>
      <li><b>Detected Speech Language:</b>
        <span id="detectedLang" class="text-warning">Not yet detected</span>
      </li>
    </ul>

    <div class="text-center my-3">
      <button id="startBtn" class="btn btn-success me-2">ğŸ¤ Start Speaking</button>
      <button id="stopBtn" class="btn btn-danger" disabled>â›” Stop & Send</button>
    </div>

    <hr>

    <h5 class="text-info text-center">Conversation Log</h5>
    <div id="conversation" class="d-flex flex-column p-3"
         style="height:320px; overflow-y:auto; background:#0f141a; border-radius:10px;">
      <div class="conversation-bubble ai-msg">
        ğŸ‘‹ Hello! Click â€œStart Speakingâ€ and talk.
      </div>
    </div>
  </div>
</div>

<script>
  const conversationBox = document.getElementById("conversation");
  const detectedLang = document.getElementById("detectedLang");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");

  function addMessage(text, sender = "user") {
    const div = document.createElement("div");
    div.className = `conversation-bubble ${sender === "ai" ? "ai-msg" : "user-msg"}`;
    div.innerText = text;
    conversationBox.appendChild(div);
    conversationBox.scrollTop = conversationBox.scrollHeight;
    return div;
  }

  async function sendSpeechToServer(blob) {
    const formData = new FormData();
    formData.append("audio_file", blob, "speech.webm");

    const statusBubble = addMessage("â³ Processing audio...", "ai");

    try {
      const res = await fetch("/chat_audio", {
        method: "POST",
        body: formData
      });

      const raw = await res.text();
      let data;

      try {
        data = JSON.parse(raw);
      } catch {
        statusBubble.innerText = "âš ï¸ Server returned invalid response.";
        return;
      }

      if (!res.ok) {
        statusBubble.innerText = "âŒ " + (data.error || "Server error");
        return;
      }

      /* ğŸ”¥ FIX FOR [object Object] ğŸ”¥ */
      const spokenText =
        typeof data.transcribed_text === "string"
          ? data.transcribed_text
          : data.transcribed_text.text;

      statusBubble.innerText = "ğŸ—£ï¸ You said: " + spokenText;

      if (data.transcribed_text.language) {
        detectedLang.innerText = data.transcribed_text.language;
      }

    } catch (err) {
      console.error(err);
      addMessage("âŒ Network error while sending audio.", "ai");
    }
  }

  let mediaRecorder;
  let audioChunks = [];
  let stream;

  startBtn.onclick = async () => {
    startBtn.disabled = true;
    stopBtn.disabled = false;

    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        const blob = new Blob(audioChunks, { type: "audio/webm;codecs=opus" });
        addMessage("Stopped recording â€” sending to server...", "ai");
        sendSpeechToServer(blob);
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };

      mediaRecorder.start();
      addMessage("ğŸ§ Listening...", "ai");

    } catch (err) {
      addMessage("ğŸ™ï¸ Microphone access denied.", "ai");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  };

  stopBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
  };
</script>

</body>
</html>
