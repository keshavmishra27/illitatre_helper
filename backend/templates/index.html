<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ™ï¸ Voice Call Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #0d1117;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar { background-color: #161b22; }
    .card {
      background-color: #1c2128;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .btn-success { background-color: #238636; border: none; }
    .btn-danger { background-color: #da3633; border: none; }

    .conversation-bubble {
      border-radius: 20px;
      padding: 10px 15px;
      margin: 6px 0;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user-msg {
      background-color: #238636;
      align-self: flex-end;
    }
    .ai-msg {
      background-color: #30363d;
      align-self: flex-start;
    }
    .error-msg {
      background-color: #8b0000;
      align-self: flex-start;
    }
  </style>
</head>

<body>

<nav class="navbar navbar-dark px-3">
  <span class="navbar-brand">ğŸ™ï¸ Voice Call Agent</span>
</nav>

<div class="container mt-4">
  <div class="card p-4">

    <h4 class="text-info text-center mb-3">User Profile</h4>
    <ul>
      <li><b>Name:</b> {{ user.name }}</li>
      <li><b>Age:</b> {{ user.age if user.age != 0 else "N/A" }}</li>
      <li><b>Preferred Language:</b> {{ user.language }}</li>
      <li><b>Detected Speech Language:</b>
        <span id="detectedLang" class="text-warning">en-IN</span>
      </li>
    </ul>

    <div class="text-center my-3">
      <button id="startBtn" class="btn btn-success me-2">ğŸ“ Start Call</button>
      <button id="stopBtn" class="btn btn-danger" disabled>â›” End Call</button>
    </div>

    <hr>

    <h5 class="text-info text-center">Conversation</h5>
    <div id="conversation"
         class="d-flex flex-column p-3"
         style="height:320px; overflow-y:auto; background:#0f141a; border-radius:10px;">
      <div class="conversation-bubble ai-msg">
        ğŸ‘‹ Hello! Click â€œStart Callâ€ and speak.
      </div>
    </div>

  </div>
</div>

<script>
  const conversationBox = document.getElementById("conversation");
  const detectedLang = document.getElementById("detectedLang");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");

  function addMessage(text, type = "ai") {
    const div = document.createElement("div");
    div.className = `conversation-bubble ${
      type === "user" ? "user-msg" :
      type === "error" ? "error-msg" : "ai-msg"
    }`;
    div.innerText = text;
    conversationBox.appendChild(div);
    conversationBox.scrollTop = conversationBox.scrollHeight;
  }

  // ğŸ¤ Browser Speech Recognition (CALL MODE)
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    addMessage("âŒ Speech recognition not supported in this browser.", "error");
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-IN";
  recognition.continuous = true;      // ğŸ”¥ Call-style
  recognition.interimResults = false;

  let listening = false;

  recognition.onresult = async (event) => {
    const text = event.results[event.results.length - 1][0].transcript;
    addMessage("ğŸ—£ï¸ " + text, "user");
    detectedLang.innerText = recognition.lang;

    try {
      const res = await fetch("/chat_text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const data = await res.json();

      if (data.ai_response) {
        addMessage("ğŸ¤– " + data.ai_response, "ai");

        // ğŸ”Š Speak AI response
        const utterance = new SpeechSynthesisUtterance(data.ai_response);
        utterance.lang = recognition.lang;
        speechSynthesis.speak(utterance);
      }

    } catch {
      addMessage("âŒ Server error while responding.", "error");
    }
  };

  recognition.onerror = (e) => {
    addMessage("âŒ Speech error: " + e.error, "error");
  };

  recognition.onend = () => {
    if (listening) recognition.start(); // auto-restart = call feel
  };

  startBtn.onclick = () => {
    listening = true;
    recognition.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
    addMessage("ğŸ§ Call started. Listening...", "ai");
  };

  stopBtn.onclick = () => {
    listening = false;
    recognition.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    addMessage("ğŸ“´ Call ended.", "ai");
  };
</script>

</body>
</html>
